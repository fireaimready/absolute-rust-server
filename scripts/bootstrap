#!/bin/bash
# =============================================================================
# Bootstrap script - Container initialization and startup
# Handles permissions, updates, Oxide installation, and launches supervisor
# =============================================================================

# Don't use set -e as SteamCMD often returns non-zero on warnings
# We handle errors explicitly instead

# Source common functions
if ! source /opt/rust/scripts/common; then
    echo "[ERROR] Failed to source common functions"
    exit 1
fi

log_info "=========================================="
log_info "Absolute Rust Server - Starting"
log_info "=========================================="

# -----------------------------------------------------------------------------
# Setup timezone
# -----------------------------------------------------------------------------
setup_timezone

# -----------------------------------------------------------------------------
# Setup permissions
# -----------------------------------------------------------------------------
setup_permissions

# -----------------------------------------------------------------------------
# Create required directories
# -----------------------------------------------------------------------------
log_info "Creating required directories"
mkdir -p "${RUST_SERVER_PATH}"
mkdir -p "${SETTINGS_PATH}"
mkdir -p "${BACKUPS_PATH}"
mkdir -p "${OXIDE_PATH}"
mkdir -p "${LOG_PATH}"
mkdir -p "${PID_PATH}"

# Create server identity directories
SERVER_DATA_PATH=$(get_server_data_path)
mkdir -p "${SERVER_DATA_PATH}/cfg"
mkdir -p "${SERVER_DATA_PATH}/storage"

# -----------------------------------------------------------------------------
# Run update on start if enabled
# -----------------------------------------------------------------------------
if is_update_on_start_enabled; then
    log_info "Update on start is enabled"

    UPDATE_TIMEOUT="${UPDATE_TIMEOUT:-1800}"
    log_info "Running SteamCMD update (timeout: ${UPDATE_TIMEOUT}s)"
    log_info "Server path: ${RUST_SERVER_PATH}"
    log_info "Server binary: ${RUST_SERVER_BINARY}"

    # Run update with timeout - don't exit on failure
    set +e
    timeout "${UPDATE_TIMEOUT}" /opt/rust/scripts/rust-updater --force
    exit_code=$?
    set -e

    if [[ ${exit_code} -eq 0 ]]; then
        log_success "Server update completed successfully"
    elif [[ ${exit_code} -eq 124 ]]; then
        log_error "Server update timed out after ${UPDATE_TIMEOUT}s"
        # Continue anyway if server files exist
        if [[ -f "${RUST_SERVER_BINARY}" ]]; then
            log_warn "Continuing with existing server files"
        else
            log_error "No server files found, cannot continue"
            exit 1
        fi
    else
        log_warn "Server update returned exit code ${exit_code}"
        if [[ -f "${RUST_SERVER_BINARY}" ]]; then
            log_warn "Continuing with existing server files"
        else
            log_error "No server files found, cannot continue"
            log_error "Check SteamCMD logs at ${LOG_PATH}/steamcmd.log"
            exit 1
        fi
    fi
else
    log_info "Update on start is disabled"
    # Check if server files exist
    if [[ ! -f "${RUST_SERVER_BINARY}" ]]; then
        log_warn "Server files not found, forcing update"
        if ! /opt/rust/scripts/rust-updater --force; then
            log_error "Failed to download server files"
            exit 1
        fi
    fi
fi

# -----------------------------------------------------------------------------
# Verify server binary exists
# -----------------------------------------------------------------------------
if [[ ! -f "${RUST_SERVER_BINARY}" ]]; then
    log_error "Server binary not found at ${RUST_SERVER_BINARY}"
    log_error "Please check SteamCMD logs for errors"
    exit 1
fi

log_success "Server binary found: ${RUST_SERVER_BINARY}"

# -----------------------------------------------------------------------------
# Fix server file permissions
# -----------------------------------------------------------------------------
log_info "Setting server file permissions for rust user"
chown -R rust:rust "${RUST_SERVER_PATH}" 2>/dev/null || true
chmod -R u+rwX "${RUST_SERVER_PATH}" 2>/dev/null || true
chmod +x "${RUST_SERVER_BINARY}" 2>/dev/null || true

# -----------------------------------------------------------------------------
# Install/Update Oxide if enabled
# -----------------------------------------------------------------------------
if is_oxide_enabled; then
    log_info "Oxide modding framework is enabled"

    if is_oxide_installed; then
        if is_oxide_auto_update_enabled; then
            log_info "Checking for Oxide updates"
            /opt/rust/scripts/oxide-installer --check-update
        else
            log_info "Oxide is installed, auto-update is disabled"
        fi
    else
        log_info "Installing Oxide modding framework"
        if /opt/rust/scripts/oxide-installer --install; then
            log_success "Oxide installed successfully"
        else
            log_warn "Failed to install Oxide, continuing without mods"
        fi
    fi
else
    log_info "Oxide modding framework is disabled"
fi

# -----------------------------------------------------------------------------
# Generate server configuration
# -----------------------------------------------------------------------------
generate_server_cfg

# -----------------------------------------------------------------------------
# Display configuration
# -----------------------------------------------------------------------------
log_info "=========================================="
log_info "Server Configuration:"
log_info "  Name: $(get_server_name)"
log_info "  Identity: $(get_server_identity)"
log_info "  Port: $(get_server_port)"
log_info "  RCON Port: $(get_rcon_port)"
log_info "  Query Port: $(get_query_port)"
log_info "  Max Players: $(get_max_players)"
log_info "  World Size: $(get_server_worldsize)"
log_info "  Level: $(get_server_level)"
log_info "  RCON: $(is_rcon_enabled && echo 'Enabled' || echo 'Disabled')"
log_info "  Oxide: $(is_oxide_enabled && echo "$(get_oxide_version)" || echo 'Disabled')"
log_info "  Backups: $(is_backups_enabled && echo 'Enabled' || echo 'Disabled')"
log_info "=========================================="

# -----------------------------------------------------------------------------
# Setup cron jobs for updates and backups
# -----------------------------------------------------------------------------
log_info "Setting up scheduled tasks"

# Create cron file
CRON_FILE="/etc/cron.d/rust"
echo "# Rust server scheduled tasks" > "${CRON_FILE}"
echo "SHELL=/bin/bash" >> "${CRON_FILE}"
echo "PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin" >> "${CRON_FILE}"

# Update cron (if configured)
if [[ -n "${UPDATE_CRON}" ]]; then
    log_info "Configuring update cron: ${UPDATE_CRON}"
    echo "${UPDATE_CRON} root /opt/rust/scripts/rust-updater >> ${LOG_PATH}/updater.log 2>&1" >> "${CRON_FILE}"
fi

# Backup cron (if enabled)
if is_backups_enabled && [[ -n "${BACKUPS_CRON}" ]]; then
    log_info "Configuring backup cron: ${BACKUPS_CRON}"
    echo "${BACKUPS_CRON} root /opt/rust/scripts/rust-backup >> ${LOG_PATH}/backup.log 2>&1" >> "${CRON_FILE}"
fi

echo "" >> "${CRON_FILE}"
chmod 644 "${CRON_FILE}"

# -----------------------------------------------------------------------------
# Start supervisor (manages server process)
# -----------------------------------------------------------------------------
log_info "Starting supervisor"
exec /usr/bin/supervisord -n -c /etc/supervisor/supervisord.conf
