#!/bin/bash
# =============================================================================
# Common Functions - Shared utilities for all Rust server scripts
# =============================================================================

# -----------------------------------------------------------------------------
# Color codes for logging
# -----------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# -----------------------------------------------------------------------------
# Logging functions
# -----------------------------------------------------------------------------
log_info() {
    echo -e "${BLUE}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*"
}

# -----------------------------------------------------------------------------
# Path constants
# -----------------------------------------------------------------------------
STEAMCMD_PATH="/opt/steamcmd"
RUST_SERVER_PATH="/opt/rust/server"
CONFIG_PATH="/config"
SETTINGS_PATH="${CONFIG_PATH}/settings"
BACKUPS_PATH="${CONFIG_PATH}/backups"
OXIDE_PATH="${CONFIG_PATH}/oxide"
LOG_PATH="/var/log/rust"
PID_PATH="/var/run/rust"

RUST_SERVER_PID="${PID_PATH}/rust-server.pid"
RUST_APP_ID="258550"

# -----------------------------------------------------------------------------
# Server binary path
# -----------------------------------------------------------------------------
RUST_SERVER_BINARY="${RUST_SERVER_PATH}/RustDedicated"

# -----------------------------------------------------------------------------
# Environment helpers
# -----------------------------------------------------------------------------
get_server_port() {
    echo "${SERVER_PORT:-28015}"
}

get_rcon_port() {
    echo "${RCON_PORT:-28016}"
}

get_rcon_web_port() {
    echo "${RCON_WEB_PORT:-28017}"
}

get_query_port() {
    echo "${QUERY_PORT:-27015}"
}

get_server_name() {
    echo "${SERVER_NAME:-Rust Server}"
}

get_server_identity() {
    echo "${SERVER_IDENTITY:-rust_server}"
}

get_server_seed() {
    # Generate random seed if not set
    if [[ -z "${SERVER_SEED}" ]]; then
        echo "$((RANDOM * RANDOM))"
    else
        echo "${SERVER_SEED}"
    fi
}

get_server_worldsize() {
    echo "${SERVER_WORLDSIZE:-4000}"
}

get_max_players() {
    echo "${SERVER_MAXPLAYERS:-50}"
}

get_server_level() {
    echo "${SERVER_LEVEL:-Procedural Map}"
}

get_save_interval() {
    echo "${SERVER_SAVEINTERVAL:-600}"
}

is_rcon_enabled() {
    [[ "${RCON_ENABLED,,}" == "true" ]]
}

is_rcon_web_enabled() {
    [[ "${RCON_WEB,,}" == "true" ]]
}

is_update_on_start_enabled() {
    [[ "${UPDATE_ON_START,,}" == "true" ]]
}

is_oxide_enabled() {
    [[ "${ENABLE_OXIDE,,}" == "true" ]]
}

is_oxide_auto_update_enabled() {
    [[ "${OXIDE_AUTO_UPDATE,,}" == "true" ]]
}

is_backups_enabled() {
    [[ "${BACKUPS_ENABLED,,}" == "true" ]]
}

# -----------------------------------------------------------------------------
# Process helpers
# -----------------------------------------------------------------------------
is_server_running() {
    if [[ -f "${RUST_SERVER_PID}" ]]; then
        local pid
        pid=$(cat "${RUST_SERVER_PID}")
        if kill -0 "${pid}" 2>/dev/null; then
            return 0
        fi
    fi
    # Also check by process name
    pgrep -f "RustDedicated" > /dev/null 2>&1
}

get_server_pid() {
    if [[ -f "${RUST_SERVER_PID}" ]]; then
        cat "${RUST_SERVER_PID}"
    else
        pgrep -f "RustDedicated" 2>/dev/null | head -1
    fi
}

get_player_count() {
    # Placeholder - would need RCON or WebSocket to get actual count
    echo "0"
}

# -----------------------------------------------------------------------------
# Permission helpers
# -----------------------------------------------------------------------------
setup_permissions() {
    local puid="${PUID:-1000}"
    local pgid="${PGID:-1000}"
    local umask_val="${UMASK:-022}"

    log_info "Setting up permissions (UID=${puid}, GID=${pgid}, UMASK=${umask_val})"

    # Set umask
    umask "${umask_val}"

    # Update rust user/group IDs if different from default
    if [[ "${puid}" != "1000" ]]; then
        usermod -o -u "${puid}" rust 2>/dev/null || true
    fi
    if [[ "${pgid}" != "1000" ]]; then
        groupmod -o -g "${pgid}" rust 2>/dev/null || true
    fi

    # Fix ownership of key directories
    chown -R rust:rust /opt/rust 2>/dev/null || true
    chown -R rust:rust /config 2>/dev/null || true
    chown -R rust:rust /var/log/rust 2>/dev/null || true
    chown -R rust:rust /var/run/rust 2>/dev/null || true
}

# -----------------------------------------------------------------------------
# Timezone setup
# -----------------------------------------------------------------------------
setup_timezone() {
    local tz="${TZ:-UTC}"

    if [[ -f "/usr/share/zoneinfo/${tz}" ]]; then
        ln -snf "/usr/share/zoneinfo/${tz}" /etc/localtime
        echo "${tz}" > /etc/timezone
        log_info "Timezone set to ${tz}"
    else
        log_warn "Invalid timezone '${tz}', using UTC"
        ln -snf /usr/share/zoneinfo/UTC /etc/localtime
        echo "UTC" > /etc/timezone
    fi
}

# -----------------------------------------------------------------------------
# SteamCMD helpers
# -----------------------------------------------------------------------------
run_steamcmd() {
    local args="$*"
    "${STEAMCMD_PATH}/steamcmd.sh" ${args}
}

get_installed_build_id() {
    local manifest="${RUST_SERVER_PATH}/steamapps/appmanifest_${RUST_APP_ID}.acf"
    if [[ -f "${manifest}" ]]; then
        grep -oP '"buildid"\s*"\K[^"]+' "${manifest}" 2>/dev/null || echo "unknown"
    else
        echo "unknown"
    fi
}

# -----------------------------------------------------------------------------
# Oxide helpers
# -----------------------------------------------------------------------------
is_oxide_installed() {
    [[ -f "${RUST_SERVER_PATH}/RustDedicated_Data/Managed/Oxide.Core.dll" ]]
}

get_oxide_version() {
    if is_oxide_installed; then
        local version_file="${RUST_SERVER_PATH}/RustDedicated_Data/Managed/Oxide.Core.dll.version"
        if [[ -f "${version_file}" ]]; then
            cat "${version_file}"
        else
            echo "installed"
        fi
    else
        echo "not installed"
    fi
}

# -----------------------------------------------------------------------------
# Server identity path helper
# -----------------------------------------------------------------------------
get_server_data_path() {
    local identity
    identity=$(get_server_identity)
    echo "${RUST_SERVER_PATH}/server/${identity}"
}

get_server_cfg_path() {
    local data_path
    data_path=$(get_server_data_path)
    echo "${data_path}/cfg"
}

# -----------------------------------------------------------------------------
# Settings file generation
# -----------------------------------------------------------------------------
generate_server_cfg() {
    local cfg_path
    cfg_path=$(get_server_cfg_path)
    local cfg_file="${cfg_path}/server.cfg"

    log_info "Generating server.cfg"

    # Create cfg directory if it doesn't exist
    mkdir -p "${cfg_path}"

    # Generate server.cfg from environment variables
    cat > "${cfg_file}" << EOF
# =============================================================================
# Rust Server Configuration
# Generated by Absolute Rust Server
# =============================================================================

# Server Identity
server.hostname "${SERVER_NAME:-Rust Server}"
server.description "${SERVER_DESCRIPTION:-}"
server.url "${SERVER_URL:-}"
server.headerimage "${SERVER_HEADERIMAGE:-}"
server.tags "${SERVER_TAGS:-}"

# Server Settings
server.maxplayers ${SERVER_MAXPLAYERS:-50}
server.worldsize ${SERVER_WORLDSIZE:-4000}
server.saveinterval ${SERVER_SAVEINTERVAL:-600}
EOF

    # Add RCON settings if enabled
    if is_rcon_enabled; then
        cat >> "${cfg_file}" << EOF

# RCON Settings
rcon.port ${RCON_PORT:-28016}
rcon.password "${RCON_PASSWORD:-}"
rcon.web $(is_rcon_web_enabled && echo "1" || echo "0")
EOF
    fi

    chown rust:rust "${cfg_file}" 2>/dev/null || true
    log_success "server.cfg generated at ${cfg_file}"
}

# -----------------------------------------------------------------------------
# Wait helpers
# -----------------------------------------------------------------------------
wait_for_server_ready() {
    local timeout="${1:-300}"
    local elapsed=0

    log_info "Waiting for server to be ready (timeout: ${timeout}s)"

    while [[ ${elapsed} -lt ${timeout} ]]; do
        # Check if process is running
        if is_server_running; then
            # Check logs for ready message
            if grep -q "Server startup complete" "${LOG_PATH}/rust-server.log" 2>/dev/null; then
                log_success "Server is ready"
                return 0
            fi
        fi
        sleep 5
        elapsed=$((elapsed + 5))
    done

    log_warn "Server readiness timeout after ${timeout}s"
    return 1
}
